"use client";

import { useEffect, useMemo, useState, useCallback } from "react";
import { useRouter } from "next/navigation";
import Container from "@mui/material/Container";
import Grid from "@mui/material/Grid";
import Box from "@mui/material/Box";
import Typography from "@mui/material/Typography";
import Paper from "@mui/material/Paper";
import Button from "@mui/material/Button";
import Chip from "@mui/material/Chip";
import Alert from "@mui/material/Alert";
import Header from "@/components/Header";

/* ===== Helpers (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô Header) ===== */
type UserLite = { username?: string; email?: string; fullname?: string };

const readCookie = (name: string): string | null => {
  const m = document.cookie.match(
    new RegExp(String.raw`(?:^|;\s*)${name}=([^;]+)`)
  );
  return m ? decodeURIComponent(m[1]) : null;
};

const readUserCookie = (): UserLite | null => {
  try {
    const raw = readCookie("user");
    if (!raw) return null;
    return JSON.parse(raw);
  } catch {
    return null;
  }
};

const parseJwtExp = (token: string): number | null => {
  try {
    const [, payload] = token.split(".");
    const json = JSON.parse(
      atob(payload.replace(/-/g, "+").replace(/_/g, "/"))
    );
    return typeof json?.exp === "number" ? json.exp : null;
  } catch {
    return null;
  }
};

export default function ListingDetail() {
  const router = useRouter();

  // ---- mock ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÉ‡∏ô‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å API/params) ----
  const listing = {
    id: "123",
    title: "‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÄ‡∏ä‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô‡πÄ‡∏õ‡∏•‡πà‡∏≤ ‡∏ï.‡∏†‡∏π‡∏™‡∏¥‡∏á‡∏´‡πå ‡∏≠.‡∏™‡∏´‡∏±‡∏™‡∏Ç‡∏±‡∏ô‡∏ò‡πå ‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏•‡∏≥‡∏õ‡∏≤‡∏ß",
    locationText: "‡∏≠.‡∏™‡∏´‡∏±‡∏™‡∏Ç‡∏±‡∏ô‡∏ò‡πå ‡∏à.‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå",
    postedAt: "08/09/2568",
    price: 45000,
    unit: "‡∏õ‡∏µ",
    status: "available" as const,
    image: "", // url ‡∏£‡∏π‡∏õ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
  };

  // ---- auth state ----
  const [user, setUser] = useState<UserLite | null>(null);
  const [tokenValid, setTokenValid] = useState(false);
  const isLoggedIn = useMemo(
    () => Boolean(user) && tokenValid,
    [user, tokenValid]
  );

  useEffect(() => {
    const syncAuth = () => {
      const token = readCookie("token");
      const u = readUserCookie();
      let valid = false;
      if (token) {
        const exp = parseJwtExp(token);
        const now = Math.floor(Date.now() / 1000);
        valid = !exp || exp > now;
      }
      setTokenValid(!!valid);
      setUser(valid ? u : null);
    };

    syncAuth();
    const onFocus = () => syncAuth();
    const onVisible = () =>
      document.visibilityState === "visible" && syncAuth();

    window.addEventListener("focus", onFocus);
    document.addEventListener("visibilitychange", onVisible);
    return () => {
      window.removeEventListener("focus", onFocus);
      document.removeEventListener("visibilitychange", onVisible);
    };
  }, []);

  // ---- ‡∏™‡πà‡∏á draft ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ inline ----
  const handleReserve = useCallback(() => {
    const draft = {
      listingId: listing.id,
      title: listing.title,
      locationText: listing.locationText,
      price: listing.price,
      unit: listing.unit as "‡∏ß‡∏±‡∏ô" | "‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" | "‡∏õ‡∏µ",
      image: listing.image,
    };
    sessionStorage.setItem("reserveDraft", JSON.stringify(draft));
    router.push(`/reserve/${listing.id}/inline`);
  }, [listing, router]);

  return (
    <>
      <Header />
      <Container maxWidth="lg" sx={{ py: { xs: 4, md: 6 } }}>
        <Paper sx={{ p: { xs: 2, md: 4 } }}>
          <Typography variant="h5" fontWeight={900} gutterBottom>
            {listing.title}
          </Typography>

          <Box sx={{ display: "flex", gap: 2, color: "text.secondary", mb: 2 }}>
            <span>üìç {listing.locationText}</span>
            <span>‚Ä¢</span>
            <span>‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® : {listing.postedAt}</span>
          </Box>

          <Grid container spacing={3}>
            <Grid size={{ xs: 12, md: 7 }}>
              <Paper
                sx={{
                  height: 380,
                  bgcolor: "rgba(0,0,0,.04)",
                  border: "1px solid rgba(0,0,0,.06)",
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                  fontSize: 22,
                  color: "text.secondary",
                }}
              >
                &lt; ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πà‡∏≤ &gt;
              </Paper>
            </Grid>

            <Grid size={{ xs: 12, md: 5 }}>
              <Paper
                sx={{
                  p: 3,
                  height: "100%",
                  display: "flex",
                  flexDirection: "column",
                }}
              >
                <Box
                  sx={{
                    display: "flex",
                    alignItems: "center",
                    justifyContent: "space-between",
                    mb: 2,
                  }}
                >
                  <Typography variant="h5" fontWeight={900} color="primary">
                    {listing.price.toLocaleString("th-TH")}/{listing.unit}
                  </Typography>
                  <Chip label="‡∏ß‡πà‡∏≤‡∏á" color="success" variant="outlined" />
                </Box>

                <Typography variant="h6" fontWeight={800} gutterBottom>
                  ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®
                </Typography>
                <Typography color="text.secondary" sx={{ lineHeight: 1.8 }}>
                  ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ä‡∏∏‡∏°‡∏ä‡∏ô ‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏≠‡∏Å‡∏™‡∏∞‡∏î‡∏ß‡∏Å ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£/‡πÇ‡∏Å‡∏î‡∏±‡∏á
                  ‡∏°‡∏µ‡∏ó‡∏≤‡∏á‡∏ô‡πâ‡∏≥‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ü‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á
                </Typography>

                <Box
                  sx={{
                    mt: "auto",
                    pt: 3,
                    display: "flex",
                    gap: 1.5,
                    alignItems: "center",
                  }}
                >
                  {isLoggedIn ? (
                    <>
                      <Button
                        variant="contained"
                        size="large"
                        onClick={handleReserve}
                      >
                        ‡∏à‡∏≠‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ
                      </Button>
                      <Button variant="outlined" size="large">
                        ‡πÅ‡∏ä‡∏£‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®
                      </Button>
                    </>
                  ) : (
                    <>
                      <Alert severity="info" sx={{ flex: 1 }}>
                        ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ
                      </Alert>
                      <Button variant="outlined" size="large">
                        ‡πÅ‡∏ä‡∏£‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®
                      </Button>
                    </>
                  )}
                </Box>
              </Paper>
            </Grid>
          </Grid>
        </Paper>
      </Container>
    </>
  );
}
