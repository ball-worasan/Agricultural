"use client";

import { useEffect, useMemo, useState, useCallback } from "react";
import Header from "@/components/Header";
import Container from "@mui/material/Container";
import Paper from "@mui/material/Paper";
import Typography from "@mui/material/Typography";
import Grid from "@mui/material/Grid";
import TextField from "@mui/material/TextField";
import Button from "@mui/material/Button";
import Box from "@mui/material/Box";
import Alert from "@mui/material/Alert";
import Link from "next/link";

import { LocalizationProvider } from "@mui/x-date-pickers/LocalizationProvider";
import { AdapterDayjs } from "@mui/x-date-pickers/AdapterDayjs";
import { DatePicker } from "@mui/x-date-pickers/DatePicker";

import dayjs, { Dayjs } from "dayjs";
import isBetween from "dayjs/plugin/isBetween";
dayjs.extend(isBetween);

/* helpers */
type UserLite = { username?: string; email?: string; fullname?: string };
const readCookie = (name: string): string | null => {
  const m = document.cookie.match(
    new RegExp(String.raw`(?:^|;\s*)${name}=([^;]+)`)
  );
  return m ? decodeURIComponent(m[1]) : null;
};
const readUserCookie = (): UserLite | null => {
  try {
    const raw = readCookie("user");
    if (!raw) return null;
    return JSON.parse(raw);
  } catch {
    return null;
  }
};

type ReserveDraft = {
  listingId: string;
  title: string;
  locationText: string;
  price: number;
  unit: "‡∏ß‡∏±‡∏ô" | "‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" | "‡∏õ‡∏µ";
  image?: string;
  fromDate?: string;
  toDate?: string;
  totalDays?: number;
  totalPrice?: number;
};

/** ‡∏ä‡πà‡∏ß‡∏á‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á) */
const BOOKED: Array<{ start: string; end: string }> = [
  { start: "2025-11-05", end: "2025-11-07" },
  { start: "2025-11-15", end: "2025-11-18" },
  { start: "2025-12-02", end: "2025-12-03" },
];

const isBooked = (d: Dayjs): boolean =>
  BOOKED.some((r) =>
    d.isBetween(
      dayjs(r.start).startOf("day"),
      dayjs(r.end).endOf("day"),
      null,
      "[]"
    )
  );

const hasBookedBetween = (start: Dayjs, end: Dayjs): boolean => {
  const a = start.startOf("day");
  const b = end.startOf("day");
  if (b.isBefore(a)) return true;
  let cur = a;
  while (cur.isSame(b) || cur.isBefore(b)) {
    if (isBooked(cur)) return true;
    cur = cur.add(1, "day");
  }
  return false;
};

const countDaysInclusive = (start: Dayjs, end: Dayjs) =>
  end.startOf("day").diff(start.startOf("day"), "day") + 1;

/** ‡∏Ñ‡∏¥‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢: ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô */
const computeTotalPrice = (
  price: number,
  unit: "‡∏ß‡∏±‡∏ô" | "‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" | "‡∏õ‡∏µ",
  totalDays: number
) => {
  const perDay =
    unit === "‡∏ß‡∏±‡∏ô" ? price : unit === "‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" ? price / 30 : price / 365;
  return Math.max(0, Math.round(perDay * totalDays)); // ‡∏õ‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö QR
};

export default function ReserveInline() {
  const [draft, setDraft] = useState<ReserveDraft | null>(null);
  const [user, setUser] = useState<UserLite | null>(null);
  const displayName = useMemo(
    () => user?.fullname || user?.username || user?.email || "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ",
    [user]
  );

  const [from, setFrom] = useState<Dayjs | null>(null);
  const [to, setTo] = useState<Dayjs | null>(null);
  const [errorText, setErrorText] = useState("");

  useEffect(() => {
    try {
      const raw = sessionStorage.getItem("reserveDraft");
      setDraft(raw ? (JSON.parse(raw) as ReserveDraft) : null);
    } catch {
      setDraft(null);
    }
    setUser(readUserCookie());
  }, []);

  useEffect(() => {
    if (!from || !to) {
      setErrorText("");
      return;
    }
    if (to.isBefore(from, "day")) {
      setErrorText("‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô");
      return;
    }
    if (hasBookedBetween(from, to)) {
      setErrorText(
        "‡∏°‡∏µ‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á‡∏Ñ‡∏±‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ"
      );
      return;
    }
    setErrorText("");
  }, [from, to]);

  const shouldDisableFrom = useCallback((d: Dayjs) => isBooked(d), []);
  const shouldDisableTo = useCallback(
    (d: Dayjs) => {
      if (isBooked(d)) return true;
      if (from && d.isBefore(from, "day")) return true;
      if (from && hasBookedBetween(from, d)) return true;
      return false;
    },
    [from]
  );

  const clearDates = () => {
    setFrom(null);
    setTo(null);
  };
  const quickPick = (days: number) => {
    if (!from) return;
    const end = from.add(days - 1, "day");
    if (!hasBookedBetween(from, end)) setTo(end);
  };

  const totalDays = useMemo(
    () => (from && to ? countDaysInclusive(from, to) : 0),
    [from, to]
  );
  const canSubmit = !!draft && !!from && !!to && !errorText;

  const handleConfirm = () => {
    if (!draft || !from || !to) return;
    const totalPrice = computeTotalPrice(draft.price, draft.unit, totalDays);
    const updated: ReserveDraft = {
      ...draft,
      fromDate: from.format("YYYY-MM-DD"),
      toDate: to.format("YYYY-MM-DD"),
      totalDays,
      totalPrice,
    };
    sessionStorage.setItem("reserveDraft", JSON.stringify(updated));
    window.location.href = `/checkout/${draft.listingId}`; // ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  };

  return (
    <>
      <Header />
      <Container maxWidth="lg" sx={{ py: { xs: 4, md: 6 } }}>
        <Paper sx={{ p: { xs: 2, md: 4 } }}>
          <Typography variant="h6" fontWeight={900} gutterBottom>
            ‡∏à‡∏≠‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πà‡∏≤
          </Typography>

          {!draft ? (
            <Alert severity="warning">
              ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏à‡∏≠‡∏á ‚Äî <Link href="/">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</Link>
            </Alert>
          ) : (
            <Grid container spacing={3}>
              <Grid size={{ xs: 12, md: 7 }}>
                <Paper
                  sx={{ height: 260, display: "grid", placeItems: "center" }}
                >
                  &lt; ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πà‡∏≤ &gt;
                </Paper>
                <Box sx={{ mt: 2, color: "text.secondary" }}>
                  <Typography fontWeight={800}>{draft.title}</Typography>
                  <Typography variant="body2">
                    üìç {draft.locationText}
                  </Typography>
                  <Typography variant="body2" color="primary">
                    {draft.price.toLocaleString("th-TH")}/{draft.unit}
                  </Typography>
                </Box>
              </Grid>

              <Grid size={{ xs: 12, md: 5 }}>
                <Paper sx={{ p: 3 }}>
                  <Typography fontWeight={800} gutterBottom>
                    ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
                  </Typography>

                  <Box sx={{ display: "grid", gap: 2 }}>
                    <TextField
                      label="‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á"
                      value={displayName}
                      disabled
                      fullWidth
                    />

                    <LocalizationProvider dateAdapter={AdapterDayjs}>
                      <Grid container spacing={1.5}>
                        <Grid size={{ xs: 12, sm: 6 }}>
                          <DatePicker
                            label="‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô"
                            value={from}
                            onChange={(v: Dayjs | null) => {
                              setFrom(v);
                              if (
                                v &&
                                to &&
                                (to.isBefore(v, "day") ||
                                  hasBookedBetween(v, to))
                              )
                                setTo(null);
                            }}
                            disablePast
                            shouldDisableDate={shouldDisableFrom}
                            slotProps={{ textField: { fullWidth: true } }}
                          />
                        </Grid>
                        <Grid size={{ xs: 12, sm: 6 }}>
                          <DatePicker
                            label="‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î"
                            value={to}
                            onChange={(v: Dayjs | null) => setTo(v)}
                            disablePast
                            minDate={from ?? dayjs()}
                            shouldDisableDate={shouldDisableTo}
                            slotProps={{ textField: { fullWidth: true } }}
                          />
                        </Grid>
                      </Grid>
                    </LocalizationProvider>

                    <Box
                      sx={{
                        display: "flex",
                        gap: 1,
                        flexWrap: "wrap",
                        alignItems: "center",
                      }}
                    >
                      <Typography
                        variant="body2"
                        sx={{ color: "text.secondary" }}
                      >
                        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏£‡πá‡∏ß:
                      </Typography>
                      <Button
                        size="small"
                        variant="outlined"
                        disabled={!from}
                        onClick={() => quickPick(7)}
                      >
                        7 ‡∏ß‡∏±‡∏ô
                      </Button>
                      <Button
                        size="small"
                        variant="outlined"
                        disabled={!from}
                        onClick={() => quickPick(15)}
                      >
                        15 ‡∏ß‡∏±‡∏ô
                      </Button>
                      <Button
                        size="small"
                        variant="outlined"
                        disabled={!from}
                        onClick={() => quickPick(30)}
                      >
                        1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                      </Button>
                      <Button size="small" color="inherit" onClick={clearDates}>
                        ‡∏•‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                      </Button>
                    </Box>

                    {errorText ? (
                      <Alert severity="warning">{errorText}</Alert>
                    ) : (
                      <Alert severity={from && to ? "success" : "info"}>
                        {from && to
                          ? `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á: ${from.format(
                              "DD/MM/YYYY"
                            )} ‡∏ñ‡∏∂‡∏á ${to.format(
                              "DD/MM/YYYY"
                            )} ‚Ä¢ ‡∏£‡∏ß‡∏° ${totalDays} ‡∏ß‡∏±‡∏ô`
                          : "‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏à‡∏≠‡∏á"}
                      </Alert>
                    )}

                    <TextField label="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏" multiline minRows={3} />

                    <Box
                      sx={{
                        display: "flex",
                        gap: 1,
                        justifyContent: "flex-end",
                      }}
                    >
                      <Button disabled={!canSubmit} onClick={handleConfirm}>
                        ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                      </Button>
                      <Button
                        variant="outlined"
                        onClick={() => {
                          sessionStorage.removeItem("reserveDraft");
                          history.back();
                        }}
                      >
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                      </Button>
                    </Box>
                  </Box>
                </Paper>
              </Grid>
            </Grid>
          )}
        </Paper>
      </Container>
    </>
  );
}
