import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import {
  Logger,
  LogLevel,
  ValidationPipe,
} from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import helmet from 'helmet';
import compression from 'compression';
import { AllExceptionsFilter } from './common/filters/http-exception.filter';
import { TimeoutInterceptor } from './common/interceptors/timeout.interceptor';

async function bootstrap() {
  const app = await NestFactory.create(AppModule, { bufferLogs: true });
  const cfg = app.get(ConfigService);
  const logger = new Logger('Bootstrap');

  // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î log level ‡∏à‡∏≤‡∏Å env
  const level = cfg.get<'log' | 'error' | 'warn' | 'debug' | 'verbose'>('logLevel', 'log');
  const ordered: LogLevel[] = ['log', 'error', 'warn', 'debug', 'verbose'];
  app.useLogger(ordered.slice(0, ordered.indexOf(level) + 1));

  // ‡πÄ‡∏û‡∏¥‡πà‡∏° security + performance header
  app.use(helmet());              // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô header ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á
  app.use(compression());         // ‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î response

  // CORS ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏•‡∏∞‡∏•‡πá‡∏≠‡∏Å‡∏ó‡∏∏‡∏Å origin
  app.enableCors({
    origin: (origin, callback) => {
      // ‡πÑ‡∏ó‡∏¢: ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ó‡∏∏‡∏Å origin ‡πÅ‡∏ï‡πà‡∏•‡πá‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
      if (!origin) {
        // ‡πÑ‡∏ó‡∏¢: ‡∏Ñ‡∏≥‡∏Ç‡∏≠ direct ‡πÄ‡∏ä‡πà‡∏ô curl/postman
        logger.debug(`CORS: no-origin (likely curl/postman) -> allowed`);
        return callback(null, true);
      }
      logger.debug(`CORS: origin=${origin} -> allowed`);
      callback(null, true);
    },
    credentials: true,
  });

  // Global pipes/filters/interceptors
  app.useGlobalPipes(new ValidationPipe({ whitelist: true, transform: true }));
  app.useGlobalFilters(new AllExceptionsFilter());
  app.useGlobalInterceptors(new TimeoutInterceptor(cfg.get<number>('requestTimeoutMs', 10000)));

  // Graceful shutdown (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡πá‡∏≠‡∏Å)
  app.enableShutdownHooks();
  const signals: NodeJS.Signals[] = ['SIGINT', 'SIGTERM'];
  signals.forEach((sig) => {
    process.on(sig, async () => {
      logger.warn(`Received ${sig}, shutting down gracefully...`);
      await app.close();
      logger.log('Nest app closed. Bye üëã');
      process.exit(0);
    });
  });

  // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ error ‡∏£‡∏∞‡∏î‡∏±‡∏ö process ‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏•‡πá‡∏≠‡∏Å‡∏Ñ‡∏£‡∏ö
  process.on('uncaughtException', (err) => {
    logger.error(`uncaughtException: ${err.message}`, (err as any)?.stack);
  });
  process.on('unhandledRejection', (reason: any) => {
    logger.error(`unhandledRejection: ${reason?.message || reason}`, reason?.stack);
  });

  const port = cfg.get<number>('port', 3000);
  await app.listen(port);
  const url = await app.getUrl();
  logger.log(`üöÄ App listening on ${url}`);
}

bootstrap().catch((err) => {
  // ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏ú‡∏∑‡πà‡∏≠ Nest logger ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°
  // eslint-disable-next-line no-console
  console.error('Bootstrap error:', err);
  process.exit(1);
});
